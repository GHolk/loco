#!/bin/bash

## chain command
mcd() { 
    mkdir $@
    cd $1
}

cls() {
    cd $1
    ls
}

err() {
    echo "$@" >&2
}

gvfs() {
    gvfs-$*
}

## change and execute command
big5() {
    luit -encoding big5 "$@"
}
value() {
    local exit_state
    case "$1" in
        -q )
            shift
            quiet "$@"
            ;;
        -Q )
            shift
            quiet -Q "$@"
            ;;
        * )
            "$@"
            ;;
    esac
    exit_state=$?
    echo $exit_state
    return $exit_state
}
quiet() {
    if [ "$1" = -Q ]
    then
        shift
        "$@" >/dev/null 2>&1
    else
        "$@" >/dev/null
    fi
}
as_return() {
    return $(($1 == 0))
}
set_if_empty() {
    local name value
    name=$1
    value="$2"
    if eval [ -z \"\$$name\" ]
    then
        eval $name='"$value"'
        return 0
    else
        return 1
    fi
}

cutdf() {
    local delimeter="$1"
    local field="$2"
    shift
    shift
    cut -d "$delimeter" -f "$field" "$@"
}

ssed() {
    local string="$1"
    shift
    echo "$string" | sed "$@"
}

acd() {
    # acd - cd to avfs directory
    # usage
    # acd # switch bewteen $HOME/.avfs$PWD and $PWD
    # acd directory # go to $HOME/.avfs/../directory
    # acd archive.tar.gz # go to $HOME/.avfs/../archive.tar.gz#
    # acd archive.rar urar # go to $HOME/.avfs/../archive.rar#urar

    if ! [ $acd_avfs_mount ]
    then
        if mount | grep -q avfs
        then acd_avfs_mount=t
        else mountavfs && acd_avfs_mount=t
        fi
    fi

    local base="$HOME/.avfs"
    local length=`expr length "$base"`

    local target="$1"
    local parameter="$2"

    local in_avfs=$(expr substr "$PWD" 1 \( $length + 1 \) = "$base/" )
    local target_path_absolute=$(expr substr "$target" 1 1 = /)

    if [ $# -eq 0 ] # switch between avfs and normal
    then
        if [ $in_avfs -eq 1 ]
        then cd "$(expr substr "$PWD" \( $length + 1 \) \( length "$PWD" \))"
        else cd "$base$PWD"
        fi
    elif [ -d "$target" ] && [ $# -eq 1 ] # go to target path in avfs
    then
        if [ $target_path_absolute -eq 1 ]
        then cd "$base$target"
        else cd "$base$PWD/$target"
        fi
    elif [ -d "$target#$parameter" ] # if target already exist as avfs, just go
    then cd "$target#$parameter"
    else # target is file
        if [ $target_path_absolute -eq 1 ]
        then cd "$base$target#$parameter"
        else cd "$base$PWD/$target#$parameter"
        fi
    fi
}

fd_is_open() {
    local fd=$1
    ( true >&$fd ) 2>/dev/null
}

fd_first_free() {
    local fd
    if [ $# -gt 0 ]
    then fd=$1
    else fd=0
    fi

    while fd_is_open $fd
    do fd=$((fd+1))
    done

    echo $fd
}

# fc for script file
fx() {
    local command=$1
    shift
    history -s fx $command

    local temp_script
    if [ -t 1 ]
    then temp_script=$(mktemp /tmp/fx.XXXXXXXX.tmp)
    fi

    (
        if [ -n "$temp_script" ]
        then exec >$temp_script
        fi

        if [ -f "$command" ]
        then
            echo \(
            echo "set -- $*"
            cat "$command"
            echo \)
        else
            case `type -t $command` in
                file)
                    echo \(
                    echo "set -- $*"
                    cat `type -P $command`
                    echo \)
                    ;;
                "function")
                    declare -f $command
                    if [ $# -gt 0 ]
                    then echo $command $*
                    fi
                    ;;
                "alias")
                    alias $command
                    if [ $# -gt 0 ]
                    then echo $command $*
                    fi
                    ;;
                "")
                    err command not found: $command
                    return 3
                    ;;
                *)
                    err not editing support command type: `type -t $command`
                    return 38
                    ;;
            esac
        fi
    )
    local exit_code=$?
    if [ -n "$temp_script" ]
    then
        if [ $exit_code -eq 0 ]
        then
            $EDITOR $temp_script
            history -s "$(cat $temp_script)"
            cat $temp_script >&2
            . $temp_script
        fi
        rm $temp_script || command rm $temp_script
    fi
    return $exit_code
}
